<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>LoRaProMini Config Tool</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        input[readonly],
        textarea[readonly] {
            background-color: #64646408 !important;
        }

        *[disabled] {
            color: #959595;
        }
    </style>
</head>

<body>

    <div class="col-lg-8 mx-auto p-3 py-md-5">
        <header class="d-flex align-items-center pb-3 mb-5 border-bottom">
            <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
                <span class="fs-4"><b>LoRaProMini</b> Config Tool</span>
            </a>
        </header>

        <main>
            <form class="needs-validation" novalidate>
                <input type="hidden" name="CONFIG_IS_VALID" value="1">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="SLEEPTIME" name="SLEEPTIME">
                    <label for="SLEEPTIME">(Deep) Sleep time between data acquisition and transmission (2 byte)</label>
                    <div class="invalid-feedback" id="SLEEPTIME_feedback"></div>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="floatingInput" name="BAT_SENSE_VBP">
                    <label for="BAT_SENSE_VBP">Volts per Bit. See documentation (4 bytes)</label>
                    <div class="invalid-feedback" id="BAT_SENSE_VBP_feedback"></div>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="floatingInput" name="BAT_MIN_VOLTAGE">
                    <label for="BAT_MIN_VOLTAGE">Minimum voltage for operation, otherwise the node continues to sleep (4
                        bytes)</label>
                    <div class="invalid-feedback" id="BAT_MIN_VOLTAGE_feedback"></div>
                </div>
                <div class="form-floating mb-3">
                    <select name="ACTIVATION_METHOD" class="form-select">
                        <option value="1" selected="selected">OTAA</option>
                        <option value="2">ABP</option>
                    </select>
                    <label for="ACTIVATION_METHOD">Activation method (1 byte)</label>
                    <div class="invalid-feedback" id="ACTIVATION_METHOD_feedback"></div>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="floatingInput" name="NWKSKEY">
                    <label for="NWKSKEY">ABP: Network Session Key (MSB, 16 bytes)</label>
                    <div class="invalid-feedback" id="NWKSKEY_feedback"></div>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="floatingInput" name="APPSKEY">
                    <label for="APPSKEY">ABP: App Session Key (MSB, 16 bytes)</label>
                    <div class="invalid-feedback" id="APPSKEY_feedback"></div>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="floatingInput" name="DEVADDR">
                    <label for="DEVADDR">ABP: Device Address (MSB, 4 bytes)</label>
                    <div class="invalid-feedback" id="DEVADDR_feedback"></div>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="floatingInput" name="APPEUI">
                    <label for="APPEUI">OTAA: Application EUI (LSB, 8 bytes)</label>
                    <div class="invalid-feedback" id="APPEUI_feedback"></div>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="floatingInput" name="DEVEUI">
                    <label for="DEVEUI">OTAA: Device EUI (LSB, 8 bytes)</label>
                    <div class="invalid-feedback" id="DEVEUI_feedback"></div>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="floatingInput" name="APPKEY">
                    <label for="APPKEY">OTAA: Application Session Key (MSB, 16 bytes)</label>
                    <div class="invalid-feedback" id="APPKEY_feedback"></div>
                </div>

                <hr class="my-5">
                
                <div class="form-floating input-group  mb-3">
                    <textarea id="configStr" style="height: 100px;" class="form-control" readonly></textarea>
                    <label for="configStr" style="z-index: 99999;">Configuration</label>
                    <button class="btn btn-outline-secondary" type="button" id="configStrCopy">Copy</button>
                </div>
                <div class="row g-2">
                    <div class="col-md">
                        <div class="form-floating">
                            <input type="text" class="form-control text-center" id="configSize" readonly>
                            <label for="configSize">Size without checksum</label>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="form-floating">
                            <input type="text" class="form-control text-center" id="configSizeCRC" readonly>
                            <label for="configSizeCRC">Size with checksum</label>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="form-floating">
                            <input type="text" class="form-control text-center" id="configCRC32" readonly>
                            <label for="configCRC32">Checksum (CRC32)</label>
                        </div>
                    </div>
                </div>




            </form>
        </main>
        <footer class="pt-3 mt-5 text-muted border-top">
            &copy; 2021 foorschtbar | <a href="https://github.com/foorschtbar/LoRaProMini">GitHub</a>
        </footer>
    </div>


</body>
<script src="https://code.jquery.com/jquery-3.6.0.slim.js"
    integrity="sha256-HwWONEZrpuoh951cQD1ov2HUK5zA5DwJ1DNUXaM6FsY=" crossorigin="anonymous"></script>

<script>

    const formFields = {
        // NAME DATATYPE DATALEN FLIPP GROUP   
        "CONFIG_IS_VALID": ["int", "1", true, 0],
        "SLEEPTIME": ["int", "2", true, 0],
        "BAT_SENSE_VBP": ["float", "4", true, 0],
        "BAT_MIN_VOLTAGE": ["float", "4", true, 0],
        "ACTIVATION_METHOD": ["int", "1", true, 0],
        "NWKSKEY": ["str", "16", false, 2],
        "APPSKEY": ["str", "16", false, 2],
        "DEVADDR": ["str", "4", true, 2],
        "APPEUI": ["str", "8", false, 1],
        "DEVEUI": ["str", "8", false, 1],
        "APPKEY": ["str", "16", false, 1],
    };

    $("#configStrCopy").click(function (e) {
        e.preventDefault();
        $("#configStr").focus();
        $("#configStr").select();
        try {
            let successful = document.execCommand('copy');
            let msg = successful ? 'successful' : 'unsuccessful';
            //alert('Copy text command was ' + msg);
        } catch (err) {
            //alert('Unable to copy');
        }
    });

    $("select, input").on('keyup keypress blur change', function (e) {
        makeConfig();
    });

    $(document).ready(function () {
        makeConfig();
    });

    function makeConfig() {
        cfgStr = "";
        error = false;
        actMethode = parseInt($("*[name='ACTIVATION_METHOD']").val());
        Object.keys(formFields).forEach(function (k) {
            hexStr = "";
            errorMsg = "";
            //console.log(k + ' - ' + values[k]);
            field = $("*[name='" + k + "']");
            fieldFeedback = $("#" + k + "_feedback");
            datatype = formFields[k][0];
            datatypeSize = parseInt(formFields[k][1]);
            dataReverse = formFields[k][2];
            dataGroup = formFields[k][3];
            if (field !== "undefined") {
                if (dataGroup > 0 && dataGroup != actMethode) {
                    field.prop("disabled", true);
                    field.removeClass("is-valid").removeClass("is-invalid");
                    cfgStr += padHexStr("", datatypeSize * 2);
                } else {
                    field.prop("disabled", false);
                    switch (datatype) {
                        case "int":
                            num = parseInt(field.val());
                            if (!isNaN(num)) {
                                if (num >= 0) {
                                    hexStr = padHexStr(num.toString(16), datatypeSize * 2);
                                    if (hexStr.length > datatypeSize * 2) {
                                        errorMsg = "Number to large";
                                    }
                                } else {
                                    errorMsg = "Number too small";
                                }
                            } else {
                                errorMsg = "Invalid number";
                            }
                            break;
                        case "float":
                            num = parseFloat(field.val());
                            if (!isNaN(num)) {
                                if (num >= 0) {
                                    hexStr = floatToHex(num);
                                } else {
                                    errorMsg = "Number too small";
                                }
                            } else {
                                errorMsg = "Invalid number";
                            }

                            break;
                        case "str":
                            let re = /([a-fA-F0-9]{2})/gm;
                            result = field.val().match(re);
                            if (result !== null) {
                                if (result.length == datatypeSize) {
                                    console.log(result.length)
                                    console.log(result);
                                    hexStr = result.join("");

                                    hexStr = padHexStr(hexStr, datatypeSize * 2);

                                } else {
                                    errorMsg = "Invalid data lenght";
                                }
                            } else {
                                errorMsg = "Invalid input";
                            }

                            break;
                    }

                    hexStr = hexStr.toUpperCase();
                    if (dataReverse) {
                        hexStr = flipHexString(hexStr, hexStr.length);
                    }

                    console.log(k + " (" + datatype + ", " + datatypeSize + ", " + dataReverse + ") " + num + " --> " + hexStr + " --> (flipped: " + flipHexString(hexStr, hexStr.length) + ")");
                    if (errorMsg != "") {
                        field.removeClass("is-valid").addClass("is-invalid");
                        fieldFeedback.html(errorMsg);
                        error = true;
                    } else {
                        field.removeClass("is-invalid").addClass("is-valid");
                        cfgStr += hexStr;
                    }
                }
            } else {
                error = true;
                console.log("Field " + k + " not found!");
            }
        });

        size = 0;
        sizecrc32 = 0;
        if (cfgStr != "" && !error) {
            chksum = padHexStr(crc32(cfgStr).toString(16), 8).toUpperCase();

            size = (cfgStr.length / 2);
            sizecrc32 = size + (chksum.length / 2);

            cfgStr = cfgStr + chksum;

            $("#configStr").val(cfgStr);
            $("#configCRC32").val(chksum);

        } else {
            $("#configStr").val("");
            $("#configCRC32").val("---");
        }
        $("#configSize").val(size);
        $("#configSizeCRC").val(sizecrc32);
    }

    // https://stackoverflow.com/questions/47164675/convert-float-to-32bit-hex-string-in-javascript
    function floatToHex(float) {
        const getHex = i => ('00' + i.toString(16)).slice(-2);

        var view = new DataView(new ArrayBuffer(4)),
            result;

        view.setFloat32(0, float);

        result = Array
            .apply(null, { length: 4 })
            .map((_, i) => getHex(view.getUint8(i)))
            .join('');

        return result;
    }

    function flipHexString(hexStr, hexDigits) {
        h = "";
        for (let i = 0; i < hexDigits; ++i) {
            h += hexStr.substr((hexDigits - 1 - i) * 2, 2);
        }
        return h;
    }

    function padHexStr(hexStr, length) {

        while (hexStr.length < length) {
            hexStr = "0" + hexStr;
        }

        return hexStr;
    }

    var makeCRCTable = function () {
        var c;
        var crcTable = [];
        for (var n = 0; n < 256; n++) {
            c = n;
            for (var k = 0; k < 8; k++) {
                c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
            }
            crcTable[n] = c;
        }
        return crcTable;
    }

    var crc32 = function (str) {
        var crcTable = window.crcTable || (window.crcTable = makeCRCTable());
        var crc = 0 ^ (-1);

        for (var i = 0; i < str.length; i++) {
            crc = (crc >>> 8) ^ crcTable[(crc ^ str.charCodeAt(i)) & 0xFF];
        }

        return (crc ^ (-1)) >>> 0;
    };

</script>

</html>